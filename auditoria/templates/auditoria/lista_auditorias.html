{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de Auditoría{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-list-ul text-primary"></i> Registros de Auditoría</h2>
                <div>
                    <span class="badge bg-info text-white">Total: {{ total_eventos }} eventos</span>
                    <a href="{% url 'dashboard' %}?rol=AUDITORIA" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-arrow-left"></i> Volver al Panel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i> Filtros de Búsqueda
                        <button class="btn btn-sm btn-outline-primary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse" aria-expanded="false" aria-controls="filtrosCollapse">
                            <i class="fas fa-search"></i> Mostrar/Ocultar
                        </button>
                    </h5>
                </div>
                <div class="collapse {% if filtros.accion or filtros.modelo or filtros.usuario or filtros.fecha_desde or filtros.fecha_hasta %}show{% endif %}" id="filtrosCollapse">
                    <div class="card-body">
                        <form method="GET" id="filtrosForm">
                        <div class="row mb-3">
                            <div class="col-md-2">
                                <label for="accion" class="form-label">Acción:</label>
                                <select name="accion" id="accion" class="form-control form-control-sm">
                                    <option value="">Todas</option>
                                    {% for accion in acciones_disponibles %}
                                        <option value="{{ accion }}" {% if filtros.accion == accion %}selected{% endif %}>
                                            {% if accion == 'CREATE' %} Creación
                                            {% elif accion == 'UPDATE' %} Modificación  
                                            {% elif accion == 'DELETE' %} Eliminación
                                            {% elif accion == 'LOGIN_SUCCESS' %} Login Exitoso
                                            {% elif accion == 'LOGIN_FAILED' %} Login Fallido
                                            {% elif accion == 'LOGOUT' %} Cierre Sesión
                                            {% elif accion == 'VIEW' %} Visualización
                                            {% elif accion == 'USER_BLOCKED' %} Usuario Bloqueado
                                            {% elif accion == 'ACCESS_DENIED' %} Acceso Denegado
                                            {% else %}{{ accion }}{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="modelo" class="form-label">Sección:</label>
                                <select name="modelo" id="modelo" class="form-control form-control-sm">
                                    <option value="">Todas las Secciones</option>
                                    <option value="Madre" {% if filtros.modelo == 'Madre' %}selected{% endif %}> Madres</option>
                                    <option value="Parto" {% if filtros.modelo == 'Parto' %}selected{% endif %}> Partos</option>
                                    <option value="RN" {% if filtros.modelo == 'RN' %}selected{% endif %}> Recién Nacidos</option>
                                    <option value="Usuario" {% if filtros.modelo == 'Usuario' %}selected{% endif %}> Administración</option>
                                    <option value="Auditoria" {% if filtros.modelo == 'Auditoria' %}selected{% endif %}> Auditoría</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="usuario" class="form-label">Usuario:</label>
                                <input type="text" name="usuario" id="usuario" class="form-control form-control-sm" 
                                       value="{{ filtros.usuario }}" placeholder="Nombre usuario">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-2">
                                <label for="fecha_desde" class="form-label">Desde:</label>
                                <input type="date" name="fecha_desde" id="fecha_desde" class="form-control form-control-sm" 
                                    value="{{ filtros.fecha_desde }}">
                            </div>
                            <div class="col-md-2">
                                <label for="orden" class="form-label">Ordenar por:</label>
                                <select name="orden" id="orden" class="form-control form-control-sm">
                                    <option value="-fecha_hora" {% if filtros.orden == '-fecha_hora' %}selected{% endif %}>Más reciente</option>
                                    <option value="fecha_hora" {% if filtros.orden == 'fecha_hora' %}selected{% endif %}>Más antiguo</option>
                                    <option value="usuario__username" {% if filtros.orden == 'usuario__username' %}selected{% endif %}>Usuario A-Z</option>
                                    <option value="-usuario__username" {% if filtros.orden == '-usuario__username' %}selected{% endif %}>Usuario Z-A</option>
                                    <option value="accion_realizada" {% if filtros.orden == 'accion_realizada' %}selected{% endif %}>Acción A-Z</option>
                                    <option value="modelo_afectado" {% if filtros.orden == 'modelo_afectado' %}selected{% endif %}>Sección A-Z</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary btn-sm me-1">
                                    <i class="fas fa-search"></i> Filtrar
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm me-1" onclick="limpiarFiltros()">
                                    <i class="fas fa-times"></i> Limpiar
                                </button>
                                <a href="{% url 'lista_auditorias' %}" class="btn btn-outline-secondary btn-sm" title="Limpiar todos los filtros">
                                    <i class="fas fa-refresh"></i> Reset
                                </a>
                            </div>
                        </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de eventos -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    {% if logs %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th><i class="fas fa-hashtag"></i> ID</th>
                                        <th><i class="fas fa-user"></i> Usuario</th>
                                        <th><i class="fas fa-clock"></i> Fecha y Hora</th>
                                        <th><i class="fas fa-cog"></i> Acción</th>
                                        <th><i class="fas fa-sitemap"></i> Sección</th>
                                        <th><i class="fas fa-eye"></i> Detalles</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in logs %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-secondary">#{{ log.id }}</span>
                                        </td>
                                        <td>
                                            <i class="fas fa-user-circle"></i> 
                                            <strong>{{ log.usuario.username|default:"Sistema" }}</strong>
                                        </td>
                                        <td class="text-nowrap">
                                            {{ log.fecha_hora|date:"d/m/Y H:i:s" }}
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if log.accion_realizada == 'CREATE' %}success{% elif log.accion_realizada == 'UPDATE' %}primary{% elif log.accion_realizada == 'DELETE' %}danger{% elif log.accion_realizada == 'LOGIN_SUCCESS' %}success{% elif log.accion_realizada == 'LOGIN_FAILED' %}danger{% elif log.accion_realizada == 'LOGOUT' %}warning{% elif log.accion_realizada == 'VIEW' %}secondary{% else %}dark{% endif %}">
                                                {% if log.accion_realizada == 'VIEW' %}Consulta{% else %}{{ log.get_accion_realizada_display }}{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <strong style="color: #000 !important;">
                                                {% if log.modelo_afectado == 'Madre' %}
                                                     Madres
                                                {% elif log.modelo_afectado == 'Parto' %}
                                                     Partos
                                                {% elif log.modelo_afectado == 'RN' %}
                                                     Recién Nacidos
                                                {% elif log.modelo_afectado == 'Usuario' %}
                                                     Administración
                                                {% elif log.modelo_afectado == 'Auditoria' %}
                                                     Auditoría
                                                {% else %}
                                                    {{ log.modelo_afectado }}
                                                {% endif %}
                                            </strong>
                                        </td>
                                        <td>
                                            <a href="{% url 'detalle_auditoria' log.id %}" class="btn btn-sm btn-outline-primary" title="Ver detalle completo">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                            <h5 style="color: #000 !important;">No hay registros de auditoría</h5>
                                            <p style="color: #000 !important;">
                                                {% if filtros.accion or filtros.modelo or filtros.usuario or filtros.fecha_desde or filtros.fecha_hasta %}
                                                    No se encontraron eventos con los filtros aplicados.
                                                    <br>
                                                    <a href="{% url 'lista_auditorias' %}" class="btn btn-sm btn-secondary mt-2">
                                                        <i class="fas fa-times"></i> Limpiar Filtros
                                                    </a>
                                                {% else %}
                                                    Los eventos de auditoría aparecerán aquí cuando se realicen acciones en el sistema.
                                                {% endif %}
                                            </p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Paginación (para futuro) -->
                        {% comment %}
                        {% if is_paginated %}
                        <nav class="mt-4">
                            <ul class="pagination justify-content-center">
                                <!-- Paginación aquí -->
                            </ul>
                        </nav>
                        {% endif %}
                        {% endcomment %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-4x mb-4" style="color: #6c757d;"></i>
                            <h4 style="color: #000 !important;">No hay eventos de auditoría registrados</h4>
                            <p style="color: #000 !important;">Los eventos aparecerán aquí cuando se realicen acciones en el sistema.</p>
                            <div class="mt-3">
                                <a href="{% url 'dashboard' %}?rol=AUDITORIA" class="btn btn-primary">
                                    <i class="fas fa-arrow-left"></i> Volver al Panel
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Información adicional -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info" style="color: #000 !important; background-color: #e7f3ff; border-color: #b8daff;">
                <h6 style="color: #000 !important;"><i class="fas fa-info-circle"></i> Información sobre Auditoría</h6>
                <ul class="mb-0 small" style="color: #000 !important;">
                    <li><strong>Solo Consulta:</strong> Los registros de auditoría solo pueden ser consultados, no modificados</li>
                    <li><strong>Automático:</strong> Los eventos se registran automáticamente por el sistema</li>
                    <li><strong>Integridad:</strong> Los registros mantienen un historial completo e inmutable de las acciones</li>
                    <li><strong>Filtros:</strong> Use los filtros para encontrar eventos específicos por fecha, usuario o tipo</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.badge {
    font-size: 0.75em;
}
.table td {
    vertical-align: middle;
}
code {
    font-size: 0.8em;
    color: #000 !important;
    background-color: #f8f9fa !important;
    border: 1px solid #dee2e6;
}
/* Forzar texto negro en todos los elementos */
.text-muted {
    color: #000 !important;
}
small.text-muted {
    color: #333 !important;
}
.form-text.text-muted {
    color: #000 !important;
}
.alert-info {
    color: #000 !important;
}
.alert-info .small {
    color: #000 !important;
}
h5, h6, p, td, th, label, small {
    color: #000 !important;
}
/* Loading spinner */
.loading-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    z-index: 1000;
}
.spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}
</style>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/listaAuditorias.js' %}"></script>
{% endblock %}
