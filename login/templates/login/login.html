<!-- login/templates/login/login.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}Iniciar Sesión - Test Fork Neonatal{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
<div class="login-container">
    <div class="login-card">
        <!-- Encabezado con información del hospital -->
        <div class="login-header">
            <div class="hospital-icon">
                <i class="fas fa-hospital"></i>
            </div>
            <h1>Test Fork Neonatal</h1>
            <h3>Hospital Herminda Martin de Chillán</h3>
            <p class="mt-3">Administración de partos, madres y recién nacidos</p>
        </div>
        
        <!-- Cuerpo del formulario -->
        <div class="login-body">
            <h2 class="text-center mb-4">Iniciar Sesión</h2>
            <p class="text-center text-muted mb-4">Ingrese sus credenciales para acceder al sistema</p>
            
            {% if form.errors %}
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span>Usuario o contraseña incorrectos. Por favor intente nuevamente.</span>
            </div>
            {% endif %}
            
            <form method="post" id="loginForm">
                {% csrf_token %}
                
                <!-- Toggle para tipo de login -->
                <div class="form-group-custom mb-2">
                    <label class="form-label-custom"><i class="fas fa-toggle-on"></i> Método de acceso</label>
                    <div class="d-flex gap-2">
                        <input type="radio" name="login_type" id="login_username" value="username" checked>
                        <label for="login_username" style="margin-right:10px;">Cuenta de usuario</label>
                        <input type="radio" name="login_type" id="login_rut" value="rut">
                        <label for="login_rut">RUT</label>
                    </div>
                </div>
                <!-- Campo de usuario dinámico -->
                <div class="form-group-custom">
                    <label for="username" class="form-label-custom">
                        <i class="fas fa-user"></i> <span id="user-label">Cuenta de usuario</span>
                    </label>
                    <input type="text" 
                        name="username" 
                        id="username" 
                        class="form-control form-control-custom" 
                        placeholder="Ingrese su username" 
                        required
                        autofocus>
                    <div class="form-text text-muted" id="user-help">Ingrese su nombre de usuario</div>
                </div>
                <!-- Campo de contraseña -->
                <div class="form-group-custom">
                    <label for="password" class="form-label-custom">
                        <i class="fas fa-lock"></i> Contraseña
                    </label>
                    <div class="password-container">
                        <input type="password" 
                            name="password" 
                            id="password" 
                            class="form-control form-control-custom" 
                            placeholder="Ingrese su contraseña" 
                            required>
                        <button type="button" class="password-toggle" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <!-- Botón de login -->
                <div class="d-grid gap-2 mb-3">
                    <button type="submit" class="btn btn-login">
                        <i class="fas fa-sign-in-alt"></i> Ingresar al Sistema
                    </button>
                </div>
                
                <!-- Información de soporte técnico -->
                <div class="support-box">
                    <h6><i class="fas fa-headset"></i> Soporte Técnico</h6>
                    <p>Si tiene problemas con su usuario o contraseña, por favor contacte al área de Tecnologías de la Información (TI) del hospital.</p>
                </div>

            </form>
            
            <!-- Footer con información adicional -->
            <div class="login-footer">
                <p><i class="fas fa-shield-alt"></i> Sistema seguro | <i class="fas fa-user-check"></i> Acceso restringido | <i class="fas fa-copyright"></i> Hospital Herminda Martin</p>
            </div>

            {% if messages %}
            <div id="django-messages" data-messages='[{% for message in messages %}{"message": "{{ message|escapejs }}", "tags": "{{ message.tags }}"}{% if not forloop.last %},{% endif %}{% endfor %}]' style="display: none;">
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/login.js' %}"></script>
<script>
// Validación SOLO si RUT está seleccionado, el listener se agrega y elimina dinámicamente
document.addEventListener('DOMContentLoaded', function() {
    const usernameRadio = document.getElementById('login_username');
    const rutRadio = document.getElementById('login_rut');
    const userLabel = document.getElementById('user-label');
    const userInput = document.getElementById('username');
    const userHelp = document.getElementById('user-help');
    let rutListener = null;

    function validarRut(valor) {
        const rutRegex = /^\d{1,2}\.\d{3}\.\d{3}-[\dkK]$/;
        return rutRegex.test(valor);
    }

    function limpiarRestricciones() {
        userInput.setCustomValidity('');
        userInput.classList.remove('is-invalid');
    }

    function addRutValidation() {
        removeRutValidation();
        rutListener = function() {
            if (userInput.value && !validarRut(userInput.value)) {
                userInput.setCustomValidity('Formato de RUT inválido. Ejemplo: 12.345.678-9');
                userInput.classList.add('is-invalid');
            } else {
                userInput.setCustomValidity('');
                userInput.classList.remove('is-invalid');
            }
        };
        userInput.addEventListener('input', rutListener);
    }

    function removeRutValidation() {
        if (rutListener) {
            userInput.removeEventListener('input', rutListener);
            rutListener = null;
        }
        limpiarRestricciones();
    }

    function updateField() {
        // Autowipe: limpiar el campo al cambiar método
        userInput.value = '';
        
        if (rutRadio.checked) {
            userLabel.textContent = 'RUT';
            userInput.placeholder = 'Ej: 12.345.678-9';
            userHelp.textContent = 'Ingrese su RUT con puntos y guión';
            addRutValidation();
        } else {
            userLabel.textContent = 'Cuenta de usuario';
            userInput.placeholder = 'Ingrese su cuenta de usuario';
            userHelp.textContent = 'Ingrese su cuenta de usuario';
            removeRutValidation();
        }
    }

    usernameRadio.addEventListener('change', updateField);
    rutRadio.addEventListener('change', updateField);
    updateField();
});
</script>
{% endblock %}