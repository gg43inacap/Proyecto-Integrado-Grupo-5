{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Barra de acciones flotante -->
            <div class="action-bar" id="actionBar">
                <div class="action-bar-content">
                    <div class="selection-info">
                        <span class="selected-count">0</span> seleccionado(s)
                    </div>
                    <div class="action-bar-buttons">
                        <button class="action-bar-btn action-bar-view" id="btnViewSelected" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                            <span>Ver</span>
                        </button>
                        <button class="action-bar-btn action-bar-edit" id="btnEditSelected" title="Editar parto">
                            <i class="fas fa-edit"></i>
                            <span>Editar</span>
                        </button>
                        <button class="action-bar-btn action-bar-add" id="btnAddRNSelected" title="Registrar RN">
                            <i class="fas fa-baby"></i>
                            <span>Registrar RN</span>
                        </button>
                        <button class="action-bar-btn action-bar-complete" id="btnCompleteSelected" title="Completar">
                            <i class="fas fa-check-circle"></i>
                            <span>Completar</span>
                        </button>
                        <button class="action-bar-btn action-bar-clear" id="btnClearSelection" title="Limpiar selección">
                            <i class="fas fa-times"></i>
                            <span>Limpiar</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-list"></i> Lista de Partos</h4>
                    <a href="{% url 'crear_parto' %}" class="btn btn-light">
                        <i class="fas fa-plus"></i> Registrar nuevo parto
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="partosTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>ID</th>
                                    <th>Madre</th>
                                    <th>Fecha y Hora</th>
                                    <th>Tipo de Parto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for parto in partos %}
                                <tr class="parto-row {% if parto.estado == 'completado' %}table-secondary{% endif %}" 
                                    data-parto-id="{{ parto.id }}" 
                                    data-parto-estado="{{ parto.estado }}"
                                    data-url-view="{% url 'detalle_parto' parto.id %}"
                                    data-url-edit="{% url 'editar_parto' parto.id %}"
                                    data-url-rn="{% url 'crear_rns' %}?parto_id={{ parto.id }}"
                                    data-url-complete="{% url 'completar_parto' parto.id %}">
                                    <td>
                                        <input type="checkbox" class="form-check-input parto-checkbox" value="{{ parto.id }}" title="Seleccionar fila">
                                    </td>
                                    <td>{{ parto.id }}</td>
                                    <td>{{ parto.madre }}</td>
                                    <td>{{parto.fecha_ingreso|date:"d/m/Y"}}</td>
                                    <td>{{ parto.hora_ingreso }}</td>
                                    <td>{{ parto.get_tipo_parto_display }}</td>
                                    <td>
                                        {% if parto.estado == 'activo' %}
                                            <span class="badge bg-success">Activo</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Completado</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="7" class="text-center text-muted">No hay partos registrados.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div class="card-footer">
                    <a href="{% url 'dashboard' %}?rol=MATRONA" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver al panel
                    </a>
                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const actionBar = document.getElementById('actionBar');
    const partoCheckboxes = document.querySelectorAll('.parto-checkbox');
    const selectedCount = document.querySelector('.selected-count');

    // Hacer que los checkboxes funcionen como radio buttons (solo uno a la vez)
    partoCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                // Deseleccionar todos los demás
                partoCheckboxes.forEach(other => {
                    if (other !== this) {
                        other.checked = false;
                    }
                });
            }
            updateActionBar();
        });
    });

    // Actualizar barra de acciones
    function updateActionBar() {
        const selectedCheckbox = document.querySelector('.parto-checkbox:checked');
        
        if (selectedCheckbox) {
            selectedCount.textContent = '1';
            actionBar.classList.add('show');
            
            // Habilitar/deshabilitar botones según estado
            const row = selectedCheckbox.closest('.parto-row');
            const estado = row.dataset.partoEstado;
            
            const btnAddRN = document.getElementById('btnAddRNSelected');
            const btnComplete = document.getElementById('btnCompleteSelected');
            
            if (estado === 'activo') {
                btnAddRN.disabled = false;
                btnComplete.disabled = false;
                btnAddRN.style.opacity = '1';
                btnComplete.style.opacity = '1';
            } else {
                btnAddRN.disabled = true;
                btnComplete.disabled = true;
                btnAddRN.style.opacity = '0.5';
                btnComplete.style.opacity = '0.5';
            }
        } else {
            selectedCount.textContent = '0';
            actionBar.classList.remove('show');
        }
    }

    // Limpiar selección
    document.getElementById('btnClearSelection').addEventListener('click', function() {
        partoCheckboxes.forEach(checkbox => checkbox.checked = false);
        updateActionBar();
    });

    // Ver primera seleccionada
    document.getElementById('btnViewSelected').addEventListener('click', function() {
        const selected = document.querySelector('.parto-checkbox:checked');
        if (selected) {
            const row = selected.closest('.parto-row');
            const url = row.dataset.urlView;
            if (url) {
                window.location.href = url;
            }
        }
    });

    // Editar primera seleccionada
    document.getElementById('btnEditSelected').addEventListener('click', function() {
        const selected = document.querySelector('.parto-checkbox:checked');
        if (selected) {
            const row = selected.closest('.parto-row');
            const url = row.dataset.urlEdit;
            if (url) {
                window.location.href = url;
            }
        }
    });

    // Registrar RN primera activa seleccionada
    document.getElementById('btnAddRNSelected').addEventListener('click', function() {
        const selected = document.querySelector('.parto-checkbox:checked');
        if (selected) {
            const row = selected.closest('.parto-row');
            const estado = row.dataset.partoEstado;
            const url = row.dataset.urlRn;
            
            if (estado === 'activo' && url) {
                window.location.href = url;
            }
        }
    });

    // Completar primera activa seleccionada
    document.getElementById('btnCompleteSelected').addEventListener('click', function() {
        const selected = document.querySelector('.parto-checkbox:checked');
        if (selected) {
            const row = selected.closest('.parto-row');
            const estado = row.dataset.partoEstado;
            const url = row.dataset.urlComplete;
            
            if (estado === 'activo') {
                if (confirm('¿Desea marcar este parto como completado?')) {
                    if (url) {
                        window.location.href = url;
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
